server {
    listen 80;
    listen [::]:80;
    server_name fakeimg.local; # Замените на ваш домен

    root /var/www/fakeimg/public; # Путь к файлам сервиса
    index index.php index.html;

    # Базовые настройки кэширования статики
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|webp)$ {
        expires 30d;
        add_header Cache-Control "public, no-transform";
        try_files $uri =404;
    }

    # Обработка PHP
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.2-fpm.sock; # Укажите вашу версию PHP
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;

        # Свои настройки кэширования для генерации изображений
        fastcgi_cache FAKECACHE;
        fastcgi_cache_valid 200 301 302 24h;
        fastcgi_cache_use_stale error timeout updating invalid_header http_500 http_503;
        fastcgi_cache_background_update on;
        fastcgi_cache_lock on;
        add_header X-Cache $upstream_cache_status;
    }

    # Основные правила обработки URL
    location / {
        try_files $uri $uri/ /index.php?$query_string;

        # Правила для генерации изображений
        rewrite "^/([0-9]+)/([0-9a-fA-F]{3,6})/([0-9a-fA-F]{3,6})/([0-9]+)x([0-9]+)\.(png|jpg|jpeg|webp)$" /index.php?size=$1&bg=$2&color=$3&width=$4&height=$5&format=$6 last;
        rewrite "^/([0-9a-fA-F]{3,6})/([0-9a-fA-F]{3,6})/([0-9]+)x([0-9]+)\.(png|jpg|jpeg|webp)$" /index.php?bg=$1&color=$2&width=$3&height=$4&format=$5 last;
        rewrite "^/([0-9]+)x([0-9]+)\.(png|jpg|jpeg|webp)$" /index.php?width=$1&height=$2&format=$3 last;
    }

    # Запрет доступа к скрытым файлам
    location ~ /\.(?!well-known).* {
        deny all;
    }

    # Логирование
    access_log /var/log/nginx/fakeimg_access.log;
    error_log /var/log/nginx/fakeimg_error.log;

    # Настройки FastCGI
    fastcgi_cache_path /var/cache/nginx/fakeimg levels=1:2 keys_zone=FAKECACHE:100m inactive=24h max_size=1g use_temp_path=off;
}